name: Build Workflow

on:
    push:
        branches: dev

jobs:
    check_project_compilation_and_tests:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: '9.x'

            - name: Restore dependencies
              run: dotnet restore Osu-maps/

            - name: Build the project
              run: dotnet build --no-restore Osu-maps/

            - name: Run tests with code coverage
              run: dotnet test --collect:"XPlat Code Coverage" --results-directory coverage Osu-maps/ --no-build -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
            
            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v2
              with:
                token: ${{ secrets.CODECOV_TOKEN }}
                fail_ci_if_error: true
                file: ./coverage/**/coverage.cobertura.xml
                flags: unittests
                verbose: true